<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, May 30, 2020, 10:30 AM -->
<!-- MuClient version 5.06-pre -->

<!-- Plugin "OCepic" generated by Plugin Wizard -->

<muclient>
<plugin
   name="OCepic"
   author="Kelaire"
   id="1ad8cdbb378258e1f343c9d7"
   purpose="Triggers and Aliases to aid in the running of the OC Epic"
   language="Lua"
   save_state="y"
   date_written="2022-01-19 10:28:38"
   requires="5.06"
   version="2.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <trigger
   enabled="n"
   group="OC"
   name="OCTestTrigger"
   match="^You give Ruby of the Court to The Keeper of the Court.$"
   regexp="y"
   script="sigBow2"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="OC"
   match="^You give Sapphire of the Deep to The keeper of the deep.$"
   regexp="y"
   script="sigBow"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="OC"
   match="^You give Emerald of Passage to The Gatekeeper.$"
   regexp="y"
   script="goDown"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="OC"
   regexp="y"
   match="^The waters begin to swirl and bubble as (?<MobName>.*) is vanquished!$"
   script="gateAlert"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="OC"
   regexp="y"
   match="^Asvarien, Lord of the Chosen gives Diamond of the Chosen to (?<PlayerName>.*)\.$"
   script="diamondOC"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="OC"
   match="^Archmage Zavin gives Ruby of the Court to (?<PlayerName>.*)\.$"
   regexp="y"
   script="rubyOC"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="OC"
   match="^Lord Protector Arkeld gives Ruby of the Court to (?<PlayerName>.*)\.$"
   regexp="y"
   script="rubyOC"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="OC"
   match="^D'vinara gives Ruby of the Court to (?<PlayerName>.*)\.$"
   regexp="y"
   script="rubyOC"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   group="OC"
   match="^A Guardian of the Deep gives Sapphire of the Deep to (?<PlayerName>.*)\.$"
   regexp="y"
   script="sapphireOC"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   name="huntOCTrigger"
   match="^You are certain that a proud warhorse is (?<Direction>.*) from here\.$"
   regexp="y"
   script="groupRename"
   sequence="100"
  >
  </trigger>
</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   match="^oc (?<endis>enable|disable)$"
   enabled="y"
   regexp="y"
   script="enableDisable"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc check$"
   enabled="y"
   regexp="y"
   script="isEnabled"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc ecn (?<echanname>.*)$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="setAliasName"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc ecn$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="showAliasName"
   sequence="101"
  >
  </alias>
  <alias
   match="^oc mob (?<mobname>.*)$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="setMobName"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc mob$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="showMobName"
   sequence="101"
  >
  </alias>
  <alias
   match="^oc finish$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="finishOC"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc start$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="startOC"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc runes (?<PlayerName>.*)$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="runesOC"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc setpath (?<dirs>.*)$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="setPath"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc newbie$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="newbieOC"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc hunt$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="huntMob"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc help$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="helpOC"
   sequence="100"
  >
  </alias>
  <alias
   match="^oc path$"
   enabled="y"
   regexp="y"
   group="OCAlias"
   script="pathOC"
   sequence="100"
  >
  </alias>
  <alias
   match="oc reload"
   enabled="y"
   script="reload_plugin"
   sequence="100"
  />
  <alias
   match="oc update check"
   enabled="y"
   script="update_check_alias"
   sequence="100"
  />
  <alias
   match="oc update install"
   enabled="y"
   script="update_install_alias"
   sequence="100"
  />
</aliases>

<script>

<![CDATA[
require("wait")
require("async")
json = require("json")
require("gmcphelper")
local groupName = nil

-- Set the alias name for the leaders epic text alias
function setAliasName(name, line, args)
	newEcn = args.echanname
	SetVariable("epic_channel_name", newEcn)
	ColourNote("Green","","OCPlugin NOTICE: Epic Channel Alias changed to ".. newEcn)
	SaveState()
end

-- Display the epic text alias to the user
function showAliasName()
	curEcn = getAliasName()
	ColourNote("Green","","OCPlugin NOTICE: Epic Channel Alias is ".. curEcn)
end

-- Return the variable that stores the epic text alias
function getAliasName()
	ecn = GetVariable("epic_channel_name") or "gtt"
	return ecn
end

-- Set the mob name
function setMobName(name, line, args)
	newMob = string.upper(args.mobname)
	SetVariable("oc_mob_name", newMob)
	ColourNote("Green","","OCPlugin NOTICE: OC Door Mob set to: ".. newMob)
	SaveState()
end

-- Display the door mob
function showMobName()
	curMob = getMobName()
	ColourNote("Green","","OCPlugin NOTICE: OC Door Mob is ".. curMob)
end

-- Return the variable that stores the epic door mob
function getMobName()
	mobName = GetVariable("oc_mob_name") or "NAPS"
	return mobName
end


-- Enable or Disable OC trigger group
function enableDisable(name, line, args)
	-- Get the text sent from the alias
	enableFlag = args.endis
	
	-- If user wants to enable
	if enableFlag == "enable" then
		ColourNote("Green","","OCPlugin NOTICE: Enabling OC Trigger Group.")
		EnableTriggerGroup ("OC", true)
		
	-- If user wants to disable
	elseif enableFlag == "disable" then
		ColourNote("Green","","OCPlugin NOTICE: Disabling OC Trigger Group.")
		EnableTriggerGroup ("OC", false)
		
	-- User sent bad data
	else
		ColourNote("Red","","OCPlugin ERROR: "..enableFlag.." is an invalid argument.")
	end
end

-- Check to see if the group is enabled - I am doing this half-assedly....checking a single trigger
function isEnabled()
	-- Check the single named trigger for enabled status
	enabledFlag = GetTriggerInfo("OCTestTrigger", 8)

	-- It's true, so they are enabled
	if enabledFlag == true then
		ColourNote("Green","","OCPlugin NOTICE: Trigger group is ENABLED.")
		
	-- It's false, so they are disabled
	elseif enabledFlag == false then
		ColourNote("Green","","OCPlugin NOTICE: Trigger group is DISABLED.")
		
	-- Honestly, it should only ever return true or false....but just in case....
	else
		ColourNote("Red","","OCPlugin ERROR: You should NEVER see this error..")
	end
end

-- Send the finish message to the group
function finishOC()
	ecn = getAliasName()
	message="Thank you for joining, please pretend to wear your mark at this time. The final command sequence is timed. You need to complete these tasks quickly so you do not get left without a reward."
	message2="Commands: @RWear signet, bow arb, wear signet, nod treasurer"
	
	Execute(ecn .. " " .. message)
	Execute(ecn .. " " .. message2)
	Execute("give diamond keeper")
	
	-- Reset the group name for next run
	groupName = nil
	
	-- Disable the trigger group
	ColourNote("Green","","OCPlugin NOTICE: Disabling OC Trigger Group.")
	EnableTriggerGroup ("OC", false)
end

function startOC()
	groupLeader = get_info_leader()	
	
	if groupLeader == "" then
		groupName = "@W" .. getMobName() .. ":EDNDS:@Y"
		Execute("group create " .. getMobName() .. ":ED - Pick a side!")
		Execute("teb broadcast oc")
		ColourNote("Green","","OCPlugin NOTICE: Enabling OC Trigger Group.")
		EnableTriggerGroup ("OC", true)
		ColourNote("Green","","OCPlugin NOTICE: Enabling Auto-Inviter.")
		--DoAfterSpecial(2,Execute("tai enable"),12)
	    elseif groupLeader == gmcp("char.base.name") then
		groupName = "@W" .. getMobName() .. ":EDNDS:@Y"
		Execute("group rename " .. getMobName() .. ":ED - Pick a side!")
		Execute("teb broadcast oc")
		ColourNote("Green","","OCPlugin NOTICE: Enabling OC Trigger Group.")
		EnableTriggerGroup ("OC", true)
		ColourNote("Green","","OCPlugin NOTICE: Enabling Auto-Inviter.")
		--DoAfterSpecial(2,Execute("tai enable"),12)
	else
		ColourNote("Red","","OCPlugin ERROR: You are not the leader in your group, dummy!")
	end
end

function get_info_leader()        
	any, p = CallPlugin("3e7dedbe37e44942dd46d264", "gmcpval", "group.leader")        
	return p 
end

function get_info_groupname()
	any, p = CallPlugin("3e7dedbe37e44942dd46d264", "gmcpval", "group.groupname")        
	return p 
end

-- Send the OC Newbie Message
function newbieOC()
	ecn = getAliasName()
	message = "This is a fast epic: please do not afk or you will be left behind. Directions are in the group name. If you die you will need to get back to the group ASAP - do not heal until you are back with the group. All you need is underwater breathing and detect invis. Wear signet and nod keeper to get past the gates. I do give grace for new runners, but after a few times you are expected to get back to the group quickly upon death. If you are non-responsive I will assume you are afk and move on. Please ask if you have any questions. Please read the guides."
	
	Execute(ecn .. " " .. message)
end

-- Give a group of runes to a player and tell them what to do
function runesOC(name, line, args)
	recipient = args.PlayerName
	Send("give ty " .. recipient)
	Send("give az " .. recipient)
	Send("give giz " .. recipient)
	Send("give vk " .. recipient)
	Send("say Give one rune to Ancient, it will take the rest")
end

-- Sapphire dropped trigger text
function sapphireOC(name, line, args)
	recipient = args.PlayerName
	ecn = getAliasName()
	leader_name = gmcp("char.base.name")
	
	message = recipient .. ", please give " .. leader_name .. " the @RSapphire"
	
	Execute(ecn .. " " .. message)
end

-- Ruby dropped trigger text
function rubyOC(name, line, args)
	recipient = args.PlayerName
	ecn = getAliasName()
	leader_name = gmcp("char.base.name")
	
	message = recipient .. ", please give " .. leader_name .. " the @RRuby"
	
	Execute(ecn .. " " .. message)
end

-- Diamond dropped trigger text
function diamondOC(name, line, args)
	recipient = args.PlayerName
	ecn = getAliasName()
	leader_name = gmcp("char.base.name")
	
	message = recipient .. ", please give " .. leader_name .. " the @RDiamond @Wand the @RRune"
	
	Execute(ecn .. " " .. message)
end

-- Announce the gate down
function gateAlert(name, line, args)
	ecn = getAliasName()
	mobKilled = args.MobName
	
	if mobKilled == "Lai" then gate = "EAST"
	elseif mobKilled == "Joshua" then gate = "SOUTH"
	elseif mobKilled == "The spirit of Sherizai" then gate = "WEST"
	elseif mobKilled == "Arizan" then gate = "NORTH"
	else gate = "ERROR" 
	end
  	
	message = "ALERT: " .. gate .. " GATE DOWN"
	
	Execute(ecn .. " " .. message)
end

-- Announce directions for wearing signet and bowing
function sigBow()
	ecn = getAliasName()
	message = "All wear signet now. command: @Rbow arb"
	
	Execute(ecn .. " " .. message)
end

-- Announce directions for wearing signet and bowing
function sigBow2()
	ecn = getAliasName()
	message = "All wear signet now. command: @Rbow arb"
	groupName = groupName .. "@W:NED"
	
	Execute(ecn .. " " .. message)
	Execute("group rename " .. groupName)
end

-- Anounce to move "DOWN"
function goDown()
	ecn = getAliasName()
	message = "Command: @RDOWN"
	
	Execute(ecn .. " " .. message)
	
	Execute("group rename " .. getMobName() .. ":EDNDS")
	
	ColourNote("Green","","OCPlugin NOTICE: Disabling Auto-Inviter.")
	Execute("tai disable")
end

-- Hunt the mob!
function huntMob()
	EnableTrigger("huntOCTrigger", true)
	Execute("hunt warhorse")
end

-- Rename the group!
function groupRename(name, line, args)
	ecn = getAliasName()
	huntDir = args.Direction
	huntDir = string.upper(string.sub(huntDir,1,1))
	EnableTrigger("huntOCTrigger", false)
	
	if groupName == nil then 
		groupName = "@W" .. getMobName() .. ":EDNDS:@Y" .. huntDir
	else
		groupName = groupName .. huntDir
	end
	
	Execute("group rename " .. groupName)
	
	length = 16 + string.len(getMobName())
	
	if #(groupName) == length then
		message = "Please do @RNOT @wAOE in this room!"
		Execute(ecn .. " " .. message)
	end
end

-- Helper Function - Tell the user how this shit works!
function helpOC()

	Note()

	ColourNote("gray", "", string.rep("-", 80))
	ColourNote("#32a83e", "", "[", "#3254a8", "", "Oradrin's Chosen Helper", "#32a83e", "", "]")
	ColourNote("gray", "", string.rep("-", 80))
	ColourNote("white", "", "This plugin will basically run OC for you!")
	ColourNote("white", "", "")
	ColourNote("white", "", "The triggers are DISABLED by default, and you can enable and disable them with a command")
	ColourNote("white", "", "")	
	ColourNote("green", "", "oc help", "white", "", " - Brings up this help menu")
	ColourNote("green", "", "oc enable", "white", "", " - Enables the triggers for this plugin")
	ColourNote("green", "", "oc disable", "white", "", " - Disables the triggers for this plugin")
	ColourNote("green", "", "oc check", "white", "", " - Checks if the plugin triggers are enabled/disabled")
	ColourNote("green", "", "oc hunt", "white", "", " - Finds the next direction in the maze and renames group")	
	ColourNote("green", "", "oc newbie", "white", "", " - Sends the OC Newbie text to the group")
	ColourNote("green", "", "oc path", "white", "", " - Sends the current path to the group")
	ColourNote("green", "", "oc setpath", "white", "", " - Sets the current path variable")
	ColourNote("green", "", "oc start", "white", "", " - create and name the OC group, and broadcast")
	ColourNote("green", "", "oc finish", "white", "", " - Sends the OC Finished text to the group")
	ColourNote("green", "", "oc ecn", "white", "", " - Shows your current epic talk alias")
	ColourNote("green", "", "oc ecn <youralias>", "white", "", " - Sets your epic talk alias to <youralias>")
	ColourNote("green", "", "oc mob", "white", "", " - Shows your current OC Door Mob")
	ColourNote("green", "", "oc mob <yourmob>", "white", "", " - Sets your OC Door Mob to <yourmob>")
	ColourNote("white", "", "")
	ColourNote("Yellow", "", "This plugin is freely shareable with any epic leader!  Share the joy, ya'll!")
	ColourNote("gray", "", string.rep("-", 80))

	Note()

end

function pathOC(name, line, args)
	i = 1
	groupName = get_info_groupname()
	ecn = getAliasName()
	
	for token in string.gmatch(groupName, "[^:]+") do
		if i == 1 then
			pathString = "c underwater, c door " .. token
			i = i + 1
		elseif i == 2 then
			pathString = pathString .. ", run " .. token
			i = i + 1
		elseif i == 3 then
			pathString = pathString .. ", wear sig, nod keeper, run " .. token
			i = i + 1
		elseif i == 4 or i == 4 then
			pathString = pathString .. ", nod keeper, run " .. token
			i = i + 1
		end
    end	
	
	Execute(ecn .. " " .. pathString)
end

function setPath(name, line, args)
	newDirs = string.upper(args.dirs)
	groupName = "@W" .. getMobName() .. ":EDNDS:@Y" .. newDirs
	Execute("group rename " .. groupName)
end


-- Wait a little bit (not long) after install and show the help!
function OnPluginInstall()
	DoAfterSpecial(.2, "helpOC()", 12)
end


----------------------- Plugin Update Code -----------------------
-- Code taken from Durel's dinv plugin, originally via Crowley

plugin_url = "https://raw.githubusercontent.com/KelaireAard/Plugins/main/ocplugin.xml"
SetVariable("DownloadURL", plugin_url)
plugin_protocol = "HTTPS"
plugin_prefix = "[OCPlugin]"

function update_check_alias()
    update_plugin("check")
    ColourNote("white", "", plugin_prefix .. " Checking for updated version...")
end

function update_install_alias()
    update_plugin("install")
    ColourNote("white", "", plugin_prefix .. " Checking for and installing updated version...")
end

function reload_plugin()
    local scriptPrefix = GetAlphaOption("script_prefix")
    local retval

    -- If the user has not already specified the script prefix for this version of mush, pick a
    -- reasonable default value
    if (scriptPrefix == "") then
        scriptPrefix = "\\\\\\"
        SetAlphaOption("script_prefix", scriptPrefix)
    end

    -- Tell mush to reload the plugin in one second.  We can't do it directly here because a
    -- plugin can't unload itself.  Even if it could, how could it tell mush to load it again
    -- if it weren't installed? 
    retval = Execute(scriptPrefix.."DoAfterSpecial(0.1, \"ReloadPlugin('"..GetPluginID().."')\", sendto.script)")
end

function update_plugin(mode)
    update_mode = mode

    wait.make(get_plugin_file)
end

function get_plugin_file()
    local urlThread = async.request(plugin_url, plugin_protocol)

    if not urlThread then
        note_error("Couldn't create async url request.")
        return
    end

    local timeout = 10
    local totTime = 0
    while (urlThread:alive() and totTime < timeout) do
        wait.time(0.1)
        totTime = totTime + 0.1
    end

    local remoteRet, pluginData, status, headers, fullStatus = urlThread:join()

    if not status then
        ColourNote("red", "", plugin_prefix .. " Couldn't download plugin file. No status code.")
        
        return
    end

    if (status ~= 200) then
        ColourNote("red", "", plugin_prefix .. " Plugin file request status code: " .. status .. ": " .. fullStatus)
        return
    end
    
    local currentVersion = GetPluginInfo(GetPluginID(), 19) or 0
    local currentVerStr  = string.format("%1.3f", currentVersion)
    local remoteVerStr   = string.match(pluginData, '%s%s+version="([0-9%.]+)"')
    local remoteVersion  = tonumber(remoteVerStr or "") or 0

    if remoteVersion == currentVersion then
        ColourNote("white", "", plugin_prefix .. " You are running the most recent version (v" .. currentVerStr .. ")")
    elseif (remoteVersion < currentVersion) then
        ColourNote("white", "", plugin_prefix .. " You have a newer version than is publicly available. (v" .. currentVerStr .. ")")
    elseif (update_mode == "check") then
        ColourNote("white", "", plugin_prefix .. " You are running v" .. currentVerStr .. ", but there's a newer version v" .. remoteVerStr)
    elseif (update_mode == "install") then
        ColourNote("white", "", plugin_prefix .. " Updating plugin from version " .. currentVerStr .. " to version " .. remoteVerStr) 

        local pluginFile = GetPluginInfo(GetPluginID(), 6)
        local file = io.open(pluginFile, "wb")
        file:write(pluginData)
        file:close()
        reload_plugin()
    else
        ColourNote("red", "", plugin_prefix .. " Invalid update mode: " .. update_mode)
    end
end
----------------------- End Plugin Update Code -----------------------

]]>

</script>


</muclient>